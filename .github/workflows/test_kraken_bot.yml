name: Testear Bot de Trading Kraken

# 1. CUANDO SE EJECUTA EL FLUJO DE TRABAJO
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite la ejecución manual desde la interfaz de GitHub

# 2. TRABAJOS (Jobs) A EJECUTAR
jobs:
  build_and_test:
    runs-on: ubuntu-latest # El servidor que ejecutará los pasos

    steps:
    - name: 1. Checkout del Código
      uses: actions/checkout@v4

    - name: 2. Construir Imagen Docker (Bot Kraken)
      # Reconstruye la imagen para asegurar que el último código esté incluido
      run: docker build -t bot-trading-macd-kraken-v1 .

    - name: 3. DEBUG - Verificar Inyección de Secrets
      run: |
        docker run \
        -e KRAKEN_API_KEY=${{ secrets.KRAKEN_API_KEY }} \
        -e KRAKEN_SECRET_KEY=${{ secrets.KRAKEN_SECRET_KEY }} \
        bot-trading-macd-kraken-v1 sh -c 'echo "Verificando KRAKEN_API_KEY: $KRAKEN_API_KEY" && echo "Verificando KRAKEN_SECRET_KEY: $KRAKEN_SECRET_KEY"'
    
    - name: 4. Ejecutar Bot (Paso real, renumerado)
      run: |
        docker run \
        -e KRAKEN_API_KEY=${{ secrets.KRAKEN_API_KEY }} \
        -e KRAKEN_SECRET_KEY=${{ secrets.KRAKEN_SECRET_KEY }} \
        bot-trading-macd-kraken-v1 python macd_trader.py